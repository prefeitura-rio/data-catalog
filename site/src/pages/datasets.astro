---
import { ArrowRight, Clock, Database, FolderKanban, Sparkles, Table as TableIcon } from '@lucide/astro';
import Button from '../components/Button.astro';
import PagefindAssets from '../components/PagefindAssets.astro';
import SearchBar from '../components/SearchBar.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getDatasetsSorted } from '../scripts/catalog.js';

const datasets = getDatasetsSorted();
const latestUpdated = datasets.length ? new Date(Math.max(...datasets.map(d => d.lastUpdated))) : null;
const recentDatasets = [...datasets].sort((a, b) => b.lastUpdated - a.lastUpdated).slice(0, 4);
const largestDatasets = [...datasets].sort((a, b) => b.tableCount - a.tableCount).slice(0, 4);
const projects = Object.entries(
	datasets.reduce((acc, dataset) => {
		acc[dataset.project] = (acc[dataset.project] || 0) + 1;
		return acc;
	}, {})
).map(([project, count]) => ({ project, count })).sort((a, b) => b.count - a.count);

const formatNumber = (value: number) => new Intl.NumberFormat('pt-BR').format(value);
---
<BaseLayout title="Lista de Datasets">
	<section class="mb-8 space-y-4">
		<div class="flex flex-wrap items-center justify-between gap-3">
			<div>
				<p class="text-xs uppercase tracking-wide text-blue-700 font-semibold">Datasets</p>
				<h1 class="text-3xl font-bold text-gray-900">Lista Completa de Bases</h1>
				<p class="text-sm text-gray-600">Explore todas as bases disponíveis no catálogo da PCRJ.</p>
			</div>
			<Button href="/datasets/" variant="secondary" class="text-sm">
				Ver lista completa
			</Button>
		</div>

		<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
			{[
				{
					label: 'Datasets',
					value: formatNumber(datasets.length),
					icon: Database,
					note: 'Catálogo completo'
				},
				{
					label: 'Tabelas',
					value: formatNumber(datasets.reduce((sum, d) => sum + d.tableCount, 0)),
					icon: TableIcon,
					note: 'Com esquemas e descrições'
				},
				{
					label: 'Projetos',
					value: formatNumber(projects.length),
					icon: FolderKanban,
					note: 'Organização por área'
				},
				{
					label: 'Última atualização',
					value: latestUpdated ? latestUpdated.toLocaleDateString('pt-BR') : '—',
					icon: Clock,
					note: latestUpdated ? 'Data mais recente' : 'Aguardando dados'
				}
			].map(card => (
				<div class="flex items-start gap-3 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
					<div class="p-2 rounded-md bg-blue-50 text-blue-700">
						<card.icon class="w-5 h-5" />
					</div>
					<div>
						<p class="text-sm text-gray-500">{card.label}</p>
						<div class="text-2xl font-semibold text-gray-900">{card.value}</div>
						{card.note && <p class="text-xs text-gray-500 mt-1">{card.note}</p>}
					</div>
				</div>
			))}
		</div>
	</section>

	<section class="mb-8">
		<SearchBar
			placeholder="Pesquisar por palavra-chave, nome, descrição, tabela ou coluna..."
			showNavLinks={false}
			containerClass="w-full"
		/>
	</section>

	<section class="mb-10">
		<div class="flex flex-wrap items-center justify-between gap-4 mb-4">
			<div>
				<p class="text-xs uppercase tracking-wide text-blue-700 font-semibold">Destaques</p>
				<h2 class="text-2xl font-semibold text-gray-900">Atualizados recentemente</h2>
				<p class="text-sm text-gray-600">Bases mais recentes no catálogo.</p>
			</div>
		</div>
		{recentDatasets.length === 0 ? (
			<div class="p-4 bg-yellow-50 border border-yellow-200 rounded-md text-sm text-yellow-800">
				Não há datasets carregados no catálogo.
			</div>
		) : (
			<div class="grid gap-4 md:grid-cols-2">
				{recentDatasets.map(dataset => (
					<a href={`/${dataset.name}/`} class="block p-4 bg-white border border-gray-200 rounded-lg hover:shadow-md hover:-translate-y-0.5 transition">
						<div class="flex items-start justify-between gap-3">
							<div class="flex-1 min-w-0">
								<div class="flex items-center gap-2 mb-2">
									<span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-blue-50 text-blue-700 border border-blue-100">
										{dataset.project}
									</span>
									<span class="text-xs text-gray-500">
										Atualizado em {new Date(dataset.lastUpdated).toLocaleDateString('pt-BR')}
									</span>
								</div>
								<h3 class="text-lg font-semibold text-gray-900 truncate">{dataset.name}</h3>
								<p class="text-sm text-gray-600 line-clamp-2">
									{dataset.description || 'Sem descrição disponível'}
								</p>
								<div class="flex items-center gap-3 text-sm text-gray-500 mt-2">
									<span class="inline-flex items-center gap-1">
										<TableIcon class="w-4 h-4" /> {dataset.tableCount} tabela{dataset.tableCount !== 1 ? 's' : ''}
									</span>
								</div>
							</div>
							<div class="p-2 text-blue-600 bg-blue-50 rounded-md">
								<Sparkles class="w-5 h-5" />
							</div>
						</div>
					</a>
				))}
			</div>
		)}
	</section>

	<section class="mb-10">
		<div class="flex flex-wrap items-center justify-between gap-4 mb-4">
			<div>
				<p class="text-xs uppercase tracking-wide text-blue-700 font-semibold">Explorar</p>
				<h2 class="text-2xl font-semibold text-gray-900">Maiores coleções</h2>
				<p class="text-sm text-gray-600">Bases com mais tabelas.</p>
			</div>
		</div>

		<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
			{largestDatasets.map(dataset => (
				<a href={`/${dataset.name}/`} class="block p-4 bg-white border border-gray-200 rounded-lg hover:shadow-md hover:-translate-y-0.5 transition">
					<h3 class="text-lg font-semibold text-gray-900 mb-1 truncate">{dataset.name}</h3>
					<p class="text-sm text-gray-600 line-clamp-2 mb-3">{dataset.description || 'Sem descrição disponível'}</p>
					<div class="flex items-center gap-3 text-sm text-gray-500">
						<span class="inline-flex items-center gap-1">
							<TableIcon class="w-4 h-4" /> {dataset.tableCount} tabela{dataset.tableCount !== 1 ? 's' : ''}
						</span>
						<span class="inline-flex items-center gap-1">
							<Database class="w-4 h-4" /> {dataset.project}
						</span>
					</div>
				</a>
			))}
		</div>
	</section>

	<section class="mb-10">
		<div class="flex flex-wrap items-center justify-between gap-4 mb-4">
			<div>
				<p class="text-xs uppercase tracking-wide text-blue-700 font-semibold">Todos os datasets</p>
				<h2 class="text-2xl font-semibold text-gray-900">Navegue pela lista completa</h2>
				<p class="text-sm text-gray-600">Resultados indexados para busca e filtragem.</p>
			</div>
		</div>

		<div class="grid gap-4 md:grid-cols-2" id="datasets-list" data-pagefind-body>
			{datasets.map(dataset => (
				<article class="flex flex-col p-5 bg-white border border-gray-200 rounded-lg transition-transform hover:-translate-y-0.5 hover:shadow-lg">
					<header class="mb-2">
						<div class="flex items-start justify-between gap-3">
							<div class="flex-1 min-w-0">
								<div class="flex items-center gap-2 mb-2">
									<span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded-full bg-blue-50 text-blue-700 border border-blue-100">
										{dataset.project}
									</span>
									<span class="text-xs text-gray-500">
										Atualizado em {new Date(dataset.lastUpdated).toLocaleDateString('pt-BR')}
									</span>
								</div>
								<h3 class="text-xl font-semibold mb-1 truncate">
									<a href={`/${dataset.name}/`} data-pagefind-meta="title" class="text-blue-600 hover:underline">{dataset.name}</a>
								</h3>
							</div>
							<Button
								variant="secondary"
								href={`/${dataset.name}/`}
								class="whitespace-nowrap text-sm"
							>
								Ver Tabelas <ArrowRight />
							</Button>
						</div>
						<div class="text-sm text-gray-500">
							{dataset.tableCount} tabela{dataset.tableCount !== 1 ? 's' : ''} •
							Atualizado em {new Date(dataset.lastUpdated).toLocaleDateString('pt-BR')}
						</div>
					</header>
					<p class="text-gray-700 leading-relaxed line-clamp-3" data-pagefind-meta="description">
						{dataset.description || 'Sem descrição disponível'}
					</p>
				</article>
			))}
		</div>
	</section>

	<PagefindAssets />
	</BaseLayout>
