---
import { ArrowLeft, Code, ExternalLink, FileCode } from '@lucide/astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import Button from '../components/Button.astro';
import StatsDisplay from '../components/StatsDisplay.astro';
import { getStaticPaths } from '../scripts/schema.js';
import { prepareDatasetTablesForRender } from '../scripts/rendering.js';
import { getDatasetPageStats } from '../scripts/stats.js';

export { getStaticPaths };

const { dataset } = Astro.props;
const tableRenderData = prepareDatasetTablesForRender(dataset.tables);
const stats = getDatasetPageStats(dataset.tables);
const defaultTableName = dataset.tables?.[0]?.name || 'SUA_TABELA_AQUI';
const defaultTableId = `${dataset.project}.${dataset.name}.${defaultTableName}`;
const datasetIdentifier = dataset.colabDatasetId || dataset.externalId || dataset.resultId || defaultTableId;
const colabNotebookUrl =
	import.meta.env.PUBLIC_COLAB_NOTEBOOK_URL
		|| 'https://colab.research.google.com/#create=true';
---
<BaseLayout title={dataset.name}>
	<header data-pagefind-body>
		<div class="mb-6">
			<Button
				variant="back"
				href="/datasets/"
				class="text-sm"
			>
				<ArrowLeft /> Voltar
			</Button>
		</div>

		<div class="text-center">
			<h1 class="text-3xl font-bold text-gray-800 mb-2" data-pagefind-meta="title">{dataset.name}</h1>
			<div class="mb-4">
				<span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
					Projeto: {dataset.project}
				</span>
			</div>
			<p class="text-lg text-gray-600 mb-8 text-justify" data-pagefind-meta="description">
				{dataset.description || 'Sem descrição disponível'}
			</p>

			<StatsDisplay stats={stats} />
		</div>
	</header>
	<section class="mb-10" data-colab-card>
		<div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between p-5 bg-orange-50 border border-orange-200 rounded-2xl">
			<div class="flex items-center gap-4">
				<div class="flex items-center justify-center w-16 h-16 rounded-full bg-white shadow-inner">
					<svg viewBox="0 0 48 48" aria-label="Google Colab" class="w-10 h-10 text-orange-500">
						<circle cx="18" cy="24" r="10" fill="currentColor" opacity="0.65"></circle>
						<circle cx="30" cy="24" r="10" fill="currentColor"></circle>
					</svg>
				</div>
				<div>
					<p class="text-xs font-semibold uppercase tracking-wide text-orange-600">Google Colab</p>
					<h2 class="text-xl font-semibold text-gray-900">Analise este dataset em um notebook Colab</h2>
				</div>
			</div>
			<div class="w-full md:w-auto flex flex-col gap-2 sm:max-w-md md:max-w-xs">
				<Button
					variant="secondary"
					size="sm"
					data-colab-launch
					data-dataset-id={datasetIdentifier}
					data-dataset-name={dataset.name}
					data-project={dataset.project}
					data-colab-url={colabNotebookUrl}
					className="justify-center w-full border-orange-500 text-orange-600 hover:bg-orange-50 hover:text-orange-800"
				>
					Abrir no Colab
				</Button>
				<p class="text-xs text-gray-600 text-center" data-colab-feedback>
					Ao clicar abrimos o Colab em nova aba e copiamos o notebook padrão para sua área de transferência.
				</p>
			</div>
		</div>
	</section>
	{tableRenderData.map((tableData) => (
		<article class="mb-8" data-pagefind-body>
			<header class="mb-4">
				<h2 class="text-2xl font-semibold text-gray-800 mb-2" data-pagefind-meta="table_name">{tableData.name}</h2>
				<p class="text-sm text-gray-500">
					{tableData.columnCount} colunas •
					Criado em {tableData.formattedDate}
				</p>

				<div class="flex flex-col sm:flex-row flex-wrap gap-3 mt-4">
					<Button
						variant="primary"
						data-copy-query
						data-project={dataset.project}
						data-dataset={dataset.name}
						data-table={tableData.name}
						data-columns={JSON.stringify(tableData.schemaEntries.map(col => col.name))}
						class="text-sm cursor-pointer w-full sm:w-auto justify-center"
					>
						<Code size={16} />
						Gerar Query
					</Button>

					<Button
						variant="secondary"
						href={`https://console.cloud.google.com/bigquery?project=${dataset.project}&ws=!1m5!1m4!4m3!1s${dataset.project}!2s${dataset.name}!3s${tableData.name}`}
						target="_blank"
						rel="noopener noreferrer"
						class="text-sm w-full sm:w-auto justify-center"
					>
						<ExternalLink size={16} />
						Abrir no BigQuery
					</Button>

					<Button
						variant="secondary"
						data-python-request
						data-project={dataset.project}
						data-dataset={dataset.name}
						data-table={tableData.name}
						data-columns={JSON.stringify(tableData.schemaEntries.map(col => col.name))}
						class="text-sm border-emerald-600 text-emerald-700 hover:bg-emerald-50 hover:text-emerald-900 w-full sm:w-auto justify-center"
					>
						<FileCode size={16} />
						Consulta com Python
					</Button>
				</div>
			</header>

			<figure class="overflow-x-auto max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
				<table class="w-full bg-white text-sm">
					<thead class="bg-gray-50 sticky top-0">
						<tr>
							<th class="px-4 sm:px-6 py-3 text-left font-medium text-gray-500 uppercase tracking-wider">
								<input
									type="checkbox"
									class="table-select-all-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
									data-table={tableData.name}
								/>
							</th>
							<th class="px-4 sm:px-6 py-3 text-left text-[0.65rem] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Nome da Coluna</th>
							<th class="px-4 sm:px-6 py-3 text-left text-[0.65rem] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
							<th class="px-4 sm:px-6 py-3 text-left text-[0.65rem] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
						</tr>
					</thead>
					<tbody class="divide-y divide-gray-200">
						{tableData.schemaEntries.map((column) => (
							<tr class="hover:bg-gray-50">
								<td class="px-4 sm:px-6 py-4 whitespace-nowrap">
									<input
										type="checkbox"
										class="column-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
										data-table={tableData.name}
										data-column={column.name}
									/>
								</td>
								<td class="px-4 sm:px-6 py-4 whitespace-nowrap overflow-x-auto">
									<code class="font-mono font-semibold text-gray-900 break-words" data-pagefind-meta="column_name">{column.name}</code>
								</td>
								<td class="px-4 sm:px-6 py-4 sm:w-80">
									<div class="max-h-20 overflow-auto bg-gray-50 p-2 rounded border-blue-200 border">
										<code class="text-xs text-blue-800 break-all font-mono" data-pagefind-meta="column_type">{column.type}</code>
									</div>
								</td>
								<td class="px-4 sm:px-6 py-4 text-sm text-gray-700 text-justify break-words" data-pagefind-meta="column_description">{column.description}</td>
							</tr>
						))}
					</tbody>
				</table>
			</figure>
		</article>
	))}
</BaseLayout>

<script>
import '../scripts/bigquery.js';
import '../scripts/colab.js';
</script>
