---
import { ArrowLeft, Code, ExternalLink } from '@lucide/astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getStaticPaths, getTotalColumns } from '../utils/schema.js';
import { prepareDatasetTablesForRender } from '../utils/rendering.js';

export { getStaticPaths };

const { dataset } = Astro.props;
const tableRenderData = prepareDatasetTablesForRender(dataset.tables);
---
<BaseLayout title={dataset.name}>
	<header data-pagefind-body>
		<div class="mb-6">
			<a href="/datasets/" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-blue-600 rounded-md hover:bg-blue-600 hover:text-white transition-all hover:-translate-x-0.5 text-sm">
				<ArrowLeft /> Voltar à Lista de Datasets
			</a>
		</div>

		<div class="text-center">
			<h1 class="text-3xl font-bold text-gray-800 mb-2" data-pagefind-meta="title">{dataset.name}</h1>
			<div class="mb-4">
				<span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
					Projeto: {dataset.project}
				</span>
			</div>
			<p class="text-lg text-gray-600 mb-8 text-justify" data-pagefind-meta="description">
				{dataset.description || 'Sem descrição disponível'}
			</p>

			<div class="flex justify-center gap-8 mb-8">
				<div class="text-center">
					<div class="text-2xl font-bold text-blue-600 mb-1">{dataset.tables.length}</div>
					<div class="text-sm text-gray-500">Tabela{dataset.tables.length !== 1 ? 's' : ''}</div>
				</div>
				<div class="text-center">
					<div class="text-2xl font-bold text-blue-600 mb-1">
						{getTotalColumns(dataset.tables)}
					</div>
					<div class="text-sm text-gray-500">Colunas Totais</div>
				</div>
			</div>
		</div>
	</header>
	{tableRenderData.map((tableData) => (
		<article class="mb-8" data-pagefind-body>
			<header class="mb-4">
				<h2 class="text-2xl font-semibold text-gray-800 mb-2" data-pagefind-meta="table_name">{tableData.name}</h2>
				<p class="text-sm text-gray-500">
					{tableData.columnCount} colunas •
					Criado em {tableData.formattedDate}
				</p>

				<div class="flex gap-3 mt-4">
					<button
						data-copy-query
						data-project={dataset.project}
						data-dataset={dataset.name}
						data-table={tableData.name}
						data-columns={JSON.stringify(tableData.schemaEntries.map(col => col.name))}
						class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm cursor-pointer"
					>
						<Code size={16} />
						Gerar Query
					</button>

					<a
						href={`https://console.cloud.google.com/bigquery?project=${dataset.project}&ws=!1m5!1m4!4m3!1s${dataset.project}!2s${dataset.name}!3s${tableData.name}`}
						target="_blank"
						rel="noopener noreferrer"
						class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-blue-600 text-blue-600 rounded-md hover:bg-blue-600 hover:text-white transition-colors text-sm"
					>
						<ExternalLink size={16} />
						Abrir no BigQuery
					</a>
				</div>
			</header>

			<figure class="overflow-x-auto max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
				<table class="w-full bg-white">
					<thead class="bg-gray-50 sticky top-0">
						<tr>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome da Coluna</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
							<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
						</tr>
					</thead>
					<tbody class="divide-y divide-gray-200">
						{tableData.schemaEntries.map((column) => (
							<tr class="hover:bg-gray-50">
								<td class="px-6 py-4 whitespace-nowrap"><code class="font-mono font-semibold text-gray-900" data-pagefind-meta="column_name">{column.name}</code></td>
								<td class="px-6 py-4 w-80">
									<div class="max-h-20 overflow-auto bg-gray-50 p-2 rounded border-blue-200 border">
										<code class="text-xs text-blue-800 break-all font-mono" data-pagefind-meta="column_type">{column.type}</code>
									</div>
								</td>
								<td class="px-6 py-4 text-sm text-gray-700 text-justify" data-pagefind-meta="column_description">{column.description}</td>
							</tr>
						))}
					</tbody>
				</table>
			</figure>
		</article>
	))}
</BaseLayout>

<script>
import '../scripts/bigquery.js';
</script>
