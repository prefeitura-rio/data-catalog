---
import { ArrowLeft, Code, ExternalLink, FileCode } from '@lucide/astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import Button from '../components/Button.astro';
import StatsDisplay from '../components/StatsDisplay.astro';
import { getStaticPaths } from '../scripts/schema.js';
import { prepareDatasetTablesForRender } from '../scripts/rendering.js';
import { getDatasetPageStats } from '../scripts/stats.js';

export { getStaticPaths };

const { dataset } = Astro.props;
const tableRenderData = prepareDatasetTablesForRender(dataset.tables);
const stats = getDatasetPageStats(dataset.tables);
const defaultTableName = dataset.tables?.[0]?.name || 'SUA_TABELA_AQUI';
const defaultTableId = `${dataset.project}.${dataset.name}.${defaultTableName}`;
const datasetIdentifier = dataset.colabDatasetId || dataset.externalId || dataset.resultId || defaultTableId;
const colabNotebookUrl =
	import.meta.env.PUBLIC_COLAB_NOTEBOOK_URL
		|| 'https://colab.research.google.com/#create=true';
---
<BaseLayout title={dataset.name}>
	<header data-pagefind-body>
		<div class="mb-6">
			<Button
				variant="back"
				href="/datasets/"
				class="text-sm"
			>
				<ArrowLeft /> Voltar
			</Button>
		</div>

		<div class="text-center">
			<h1 class="text-3xl font-bold text-gray-800 mb-2" data-pagefind-meta="title">{dataset.name}</h1>
			<div class="mb-4">
				<span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
					Projeto: {dataset.project}
				</span>
			</div>
			<p class="text-lg text-gray-600 mb-8 text-justify" data-pagefind-meta="description">
				{dataset.description || 'Sem descrição disponível'}
			</p>

			<StatsDisplay stats={stats} />
		</div>
	</header>
	<section class="mb-10" data-colab-card>
		<div class="flex flex-col gap-5 md:flex-row md:items-center md:justify-between p-4 sm:p-6 bg-amber-50 border border-amber-200 rounded-2xl">
			<div class="flex flex-col sm:flex-row items-start gap-4 text-center sm:text-left">
				<div class="flex items-center justify-center w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-white shadow-inner text-amber-500 font-semibold text-xl sm:text-2xl mx-auto sm:mx-0">
					CO
				</div>
				<div class="space-y-3">
					<p class="text-xs font-semibold uppercase tracking-wide text-amber-600">Google Colab</p>
					<h2 class="text-xl font-semibold text-gray-900">Analise este dataset em um notebook Colab</h2>
					<ol class="list-decimal list-inside text-sm text-gray-700 space-y-1">
						<li>Copie o ID completo da tabela (projeto.dataset.tabela).</li>
						<li>Clique em &quot;Abrir no Colab&quot;.</li>
						<li>Cole o código copiado automaticamente, ajuste os parâmetros se necessário e execute.</li>
					</ol>
				</div>
			</div>
			<div class="w-full md:w-auto flex flex-col gap-3 sm:max-w-md md:max-w-none">
				<div class="text-xs uppercase tracking-wide font-semibold text-amber-700">ID da tabela</div>
				<div class="flex flex-wrap items-center gap-3">
					<code class="px-3 py-2 bg-white border border-amber-200 rounded-md font-mono text-sm text-amber-700 break-all w-full sm:flex-1 text-center sm:text-left">
						{datasetIdentifier}
					</code>
					<button
						type="button"
						class="px-3 py-2 text-sm font-semibold text-amber-700 border border-amber-300 rounded-md hover:bg-amber-100 transition w-full sm:w-auto"
						data-colab-copy
						data-dataset-id={datasetIdentifier}
					>
						Copiar
					</button>
				</div>
				<p class="text-[0.7rem] text-gray-600">
					Ajuste o final do ID caso queira outra tabela do mesmo dataset.
				</p>
				<Button
					variant="secondary"
					data-colab-launch
					data-dataset-id={datasetIdentifier}
					data-dataset-name={dataset.name}
					data-project={dataset.project}
					data-colab-url={colabNotebookUrl}
					className="text-sm justify-center w-full"
				>
					Abrir no Colab
				</Button>
				<p class="text-xs text-gray-600" data-colab-feedback>
					Ao clicar vamos abrir o Google Colab em uma nova aba e copiar o notebook padrão para a sua área de transferência.
				</p>
			</div>
		</div>
	</section>
	{tableRenderData.map((tableData) => (
		<article class="mb-8" data-pagefind-body>
			<header class="mb-4">
				<h2 class="text-2xl font-semibold text-gray-800 mb-2" data-pagefind-meta="table_name">{tableData.name}</h2>
				<p class="text-sm text-gray-500">
					{tableData.columnCount} colunas •
					Criado em {tableData.formattedDate}
				</p>

				<div class="flex flex-col sm:flex-row flex-wrap gap-3 mt-4">
					<Button
						variant="primary"
						data-copy-query
						data-project={dataset.project}
						data-dataset={dataset.name}
						data-table={tableData.name}
						data-columns={JSON.stringify(tableData.schemaEntries.map(col => col.name))}
						class="text-sm cursor-pointer w-full sm:w-auto justify-center"
					>
						<Code size={16} />
						Gerar Query
					</Button>

					<Button
						variant="secondary"
						href={`https://console.cloud.google.com/bigquery?project=${dataset.project}&ws=!1m5!1m4!4m3!1s${dataset.project}!2s${dataset.name}!3s${tableData.name}`}
						target="_blank"
						rel="noopener noreferrer"
						class="text-sm w-full sm:w-auto justify-center"
					>
						<ExternalLink size={16} />
						Abrir no BigQuery
					</Button>

					<Button
						variant="secondary"
						data-python-request
						data-project={dataset.project}
						data-dataset={dataset.name}
						data-table={tableData.name}
						data-columns={JSON.stringify(tableData.schemaEntries.map(col => col.name))}
						class="text-sm border-emerald-600 text-emerald-700 hover:bg-emerald-50 hover:text-emerald-900 w-full sm:w-auto justify-center"
					>
						<FileCode size={16} />
						Consulta com Python
					</Button>
				</div>
			</header>

			<figure class="overflow-x-auto max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
				<table class="w-full bg-white text-sm">
					<thead class="bg-gray-50 sticky top-0">
						<tr>
							<th class="px-4 sm:px-6 py-3 text-left text-[0.65rem] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">
								<input
									type="checkbox"
									class="table-select-all-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
									data-table={tableData.name}
								/>
							</th>
							<th class="px-4 sm:px-6 py-3 text-left text-[0.65rem] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Nome da Coluna</th>
							<th class="px-4 sm:px-6 py-3 text-left text-[0.65rem] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
							<th class="px-4 sm:px-6 py-3 text-left text-[0.65rem] sm:text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
						</tr>
					</thead>
					<tbody class="divide-y divide-gray-200">
						{tableData.schemaEntries.map((column) => (
							<tr class="hover:bg-gray-50">
								<td class="px-4 sm:px-6 py-4 whitespace-nowrap">
									<input
										type="checkbox"
										class="column-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
										data-table={tableData.name}
										data-column={column.name}
									/>
								</td>
								<td class="px-4 sm:px-6 py-4 whitespace-nowrap">
									<code class="font-mono font-semibold text-gray-900 break-all" data-pagefind-meta="column_name">{column.name}</code>
								</td>
								<td class="px-4 sm:px-6 py-4 sm:w-80">
									<div class="max-h-20 overflow-auto bg-gray-50 p-2 rounded border-blue-200 border">
										<code class="text-xs text-blue-800 break-all font-mono" data-pagefind-meta="column_type">{column.type}</code>
									</div>
								</td>
								<td class="px-4 sm:px-6 py-4 text-sm text-gray-700 text-justify break-words" data-pagefind-meta="column_description">{column.description}</td>
							</tr>
						))}
					</tbody>
				</table>
			</figure>
		</article>
	))}
</BaseLayout>

<script>
import '../scripts/bigquery.js';
import '../scripts/colab.js';
</script>
